{% extends "base.html" %}

{% block content %}
<!-- Add this to user_settings.html before the medication timings section -->
<div class="card mb-4">
    <div class="card-header">
        <h4>Profile Information</h4>
    </div>
    <div class="card-body">
        <form method="POST" action="{{ url_for('update_profile') }}">
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="username" class="form-label">Username</label>
                    <input type="text" class="form-control" id="username" name="username" 
                           value="{{ current_user.username }}" required>
                </div>
                <div class="col-md-6 mb-3">
                    <label for="email" class="form-label">Email</label>
                    <input type="email" class="form-control" id="email" name="email" 
                           value="{{ current_user.email }}" required>
                </div>
            </div>
            
            <div class="d-grid gap-2">
                <button type="submit" class="btn btn-primary">Update Profile</button>
            </div>
        </form>
    </div>
</div>

<div class="container mt-4">
    <h2>Medication Timing Settings</h2>
    
    {% with messages = get_flashed_messages() %}
        {% if messages %}
            {% for message in messages %}
                <div class="alert alert-info alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            {% endfor %}
        {% endif %}
    {% endwith %}
    
    <div class="card mb-4">
        <div class="card-header">
            <h4>Default Medication Timings</h4>
        </div>
        <div class="card-body">
            <p class="text-muted">
                Set your preferred times for taking medication. These settings will be used for all new 
                medication reminders.
            </p>
            
            <form method="POST" action="{{ url_for('user_settings') }}">
                <div class="row mb-4">
                    <div class="col-md-12">
                        <h5>Once Daily Medication</h5>
                        <div class="mb-3">
                            <label for="once_daily_time" class="form-label">Preferred Time</label>
                            <input type="time" class="form-control" id="once_daily_time" name="once_daily_time" 
                                value="{{ user_prefs.once_daily_time }}" required>
                            <div class="form-text">Default: 8:00 PM</div>
                        </div>
                    </div>
                </div>
                
                <div class="row mb-4">
                    <div class="col-md-12">
                        <h5>Twice Daily Medication</h5>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="twice_daily_time_1" class="form-label">Morning Time</label>
                                <input type="time" class="form-control" id="twice_daily_time_1" name="twice_daily_time_1" 
                                    value="{{ user_prefs.twice_daily_time_1 }}" required>
                                <div class="form-text">Default: 8:00 AM</div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="twice_daily_time_2" class="form-label">Evening Time</label>
                                <input type="time" class="form-control" id="twice_daily_time_2" name="twice_daily_time_2" 
                                    value="{{ user_prefs.twice_daily_time_2 }}" required>
                                <div class="form-text">Default: 8:00 PM</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="row mb-4">
                    <div class="col-md-12">
                        <h5>Three Times Daily Medication</h5>
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label for="thrice_daily_time_1" class="form-label">Morning Time</label>
                                <input type="time" class="form-control" id="thrice_daily_time_1" name="thrice_daily_time_1" 
                                    value="{{ user_prefs.thrice_daily_time_1 }}" required>
                                <div class="form-text">Default: 8:00 AM</div>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="thrice_daily_time_2" class="form-label">Afternoon Time</label>
                                <input type="time" class="form-control" id="thrice_daily_time_2" name="thrice_daily_time_2" 
                                    value="{{ user_prefs.thrice_daily_time_2 }}" required>
                                <div class="form-text">Default: 2:00 PM</div>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="thrice_daily_time_3" class="form-label">Evening Time</label>
                                <input type="time" class="form-control" id="thrice_daily_time_3" name="thrice_daily_time_3" 
                                    value="{{ user_prefs.thrice_daily_time_3 }}" required>
                                <div class="form-text">Default: 8:00 PM</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- WhatsApp Notification Settings -->
                <div class="mb-4">
                    <h5>üì± WhatsApp Notifications</h5>
                    <div class="alert alert-success">
                        <strong>üöÄ FULLY AUTOMATIC WhatsApp Integration!</strong><br>
                        <small>‚úÖ No QR scanning needed ‚Ä¢ ‚úÖ No browser intervention ‚Ä¢ ‚úÖ Works seamlessly in background</small>
                    </div>
                    
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="whatsapp_enabled" name="whatsapp_enabled" 
                               {% if user_prefs.whatsapp_enabled %}checked{% endif %}>
                        <label class="form-check-label" for="whatsapp_enabled">
                            <strong>Enable Automatic WhatsApp Notifications</strong>
                        </label>
                        <div class="form-text">
                            üîî Get instant medication reminders on WhatsApp + voice alerts for maximum reliability
                        </div>
                    </div>
                    
                    <div class="mb-3" id="whatsapp_phone_group" style="display: none;">
                        <label for="whatsapp_phone" class="form-label">
                            <strong>üìû Your WhatsApp Phone Number</strong> <span class="text-danger">*</span>
                        </label>
                        <div class="input-group">
                            <span class="input-group-text">üì±</span>
                            <input type="tel" class="form-control" id="whatsapp_phone" name="whatsapp_phone" 
                                   value="{{ user_prefs.whatsapp_phone or '' }}" 
                                   placeholder="+919876543210"
                                   pattern="(\+91|91)?[6-9][0-9]{9}"
                                   title="Enter a valid Indian mobile number">
                        </div>
                        <div class="form-text">
                            <strong>Format examples:</strong><br>
                            ‚Ä¢ <code>+919876543210</code> (with country code)<br>
                            ‚Ä¢ <code>9876543210</code> (10-digit number - we'll add +91)<br>
                            <small class="text-muted">‚ö†Ô∏è Make sure this number is registered with WhatsApp</small>
                        </div>
                        
                        <div class="alert alert-success mt-2" style="font-size: 0.9em;">
                            <strong>üéâ How Automatic WhatsApp Works:</strong><br>
                            1Ô∏è‚É£ <strong>No Setup Needed:</strong> Just enable and enter your number<br>
                            2Ô∏è‚É£ <strong>Automatic Delivery:</strong> Messages open instantly in WhatsApp<br>
                            3Ô∏è‚É£ <strong>Multiple Methods:</strong> Click-to-chat, desktop app, or web interface<br>
                            4Ô∏è‚É£ <strong>Pre-filled Messages:</strong> Just click "Send" to deliver<br>
                            5Ô∏è‚É£ <strong>Smart Fallbacks:</strong> Always finds a way to reach you!
                        </div>
                    </div>
                    
                    <!-- Test WhatsApp Button -->
                    <div id="whatsapp_test_section" style="display: none;">
                        <div class="d-flex gap-2 mb-2">
                            <button type="button" class="btn btn-success btn-sm" id="test_whatsapp_btn">
                                üß™ Test Automatic WhatsApp
                            </button>
                        </div>
                        <div class="alert alert-info mt-2" style="font-size: 0.85em;">
                            <strong>ÔøΩ Testing:</strong> Click test button to see how automatic WhatsApp works!<br>
                            The message will open instantly in WhatsApp - just click Send to complete delivery.
                        </div>
                    </div>
                </div>
                
                <div class="mb-4">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" value="yes" id="update_existing" name="update_existing">
                        <label class="form-check-label" for="update_existing">
                            Update existing upcoming reminders with these new timings
                        </label>
                        <div class="form-text">
                            This will adjust the time (but not the date) of all your upcoming medication reminders
                            to match your new preferred times.
                        </div>
                    </div>
                </div>
                
                <div class="d-grid gap-2">
                    <button type="submit" class="btn btn-primary">Save Settings</button>
                    <a href="{{ url_for('dashboard') }}" class="btn btn-outline-secondary">Back to Dashboard</a>
                    <a href="{{ url_for('view_reminders') }}" class="btn btn-secondary">View Updated Reminders</a>
                    
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// Toggle WhatsApp phone number field visibility
document.addEventListener('DOMContentLoaded', function() {
    const whatsappEnabled = document.getElementById('whatsapp_enabled');
    const phoneGroup = document.getElementById('whatsapp_phone_group');
    
    function togglePhoneField() {
        if (whatsappEnabled.checked) {
            phoneGroup.style.display = 'block';
        } else {
            phoneGroup.style.display = 'none';
        }
    }
    
    // Set initial state
    togglePhoneField();
    
    // Add event listener
    whatsappEnabled.addEventListener('change', togglePhoneField);
});
</script>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // WhatsApp settings functionality
    const whatsappCheckbox = document.getElementById('whatsapp_enabled');
    const whatsappPhoneGroup = document.getElementById('whatsapp_phone_group');
    const whatsappTestSection = document.getElementById('whatsapp_test_section');
    const whatsappPhoneInput = document.getElementById('whatsapp_phone');
    
    function toggleWhatsAppFields() {
        if (whatsappCheckbox.checked) {
            whatsappPhoneGroup.style.display = 'block';
            whatsappTestSection.style.display = 'block';
            whatsappPhoneInput.required = true;
        } else {
            whatsappPhoneGroup.style.display = 'none';
            whatsappTestSection.style.display = 'none';
            whatsappPhoneInput.required = false;
        }
    }
    
    // Initial toggle state
    if (whatsappCheckbox) {
        toggleWhatsAppFields();
        whatsappCheckbox.addEventListener('change', toggleWhatsAppFields);
    }
    
    // Format phone number input
    if (whatsappPhoneInput) {
        whatsappPhoneInput.addEventListener('input', function() {
            let value = this.value.replace(/\D/g, ''); // Remove non-digits
            
            // If it starts with 91 and has more than 12 digits, remove leading 91
            if (value.startsWith('91') && value.length > 12) {
                value = value.substring(2);
            }
            
            // Limit to 10 digits for Indian numbers
            if (value.length > 10) {
                value = value.substring(0, 10);
            }
            
            // Format display
            if (value.length === 10 && value.startsWith('9') || value.startsWith('8') || 
                value.startsWith('7') || value.startsWith('6')) {
                this.value = '+91' + value;
            } else if (value.length <= 10) {
                this.value = value;
            }
        });
    }
    
    // Initialize automatic WhatsApp functionality
    const initWhatsAppBtn = document.getElementById('init_whatsapp_btn');
    if (initWhatsAppBtn) {
        initWhatsAppBtn.addEventListener('click', function() {
            this.disabled = true;
            this.innerHTML = '‚è≥ Initializing...';
            
            fetch('/initialize_whatsapp', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('‚úÖ ' + data.message + '\n\nYou can now send automatic WhatsApp reminders!');
                    this.innerHTML = '‚úÖ Initialized';
                    this.classList.remove('btn-outline-primary');
                    this.classList.add('btn-success');
                } else {
                    alert('‚ùå Initialization failed: ' + (data.error || 'Unknown error'));
                    this.disabled = false;
                    this.innerHTML = 'üöÄ Initialize Auto WhatsApp';
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('‚ùå Error during initialization. Please try again.');
                this.disabled = false;
                this.innerHTML = 'üöÄ Initialize Auto WhatsApp';
            });
        });
    }
    
    // Test WhatsApp functionality
    const testWhatsAppBtn = document.getElementById('test_whatsapp_btn');
    if (testWhatsAppBtn) {
        testWhatsAppBtn.addEventListener('click', function() {
            const phoneNumber = whatsappPhoneInput.value.trim();
            
            if (!phoneNumber) {
                alert('Please enter your WhatsApp phone number first.');
                whatsappPhoneInput.focus();
                return;
            }
            
            // Validate phone number format
            const phoneRegex = /^(\+91|91)?[6-9][0-9]{9}$/;
            if (!phoneRegex.test(phoneNumber.replace(/\s+/g, ''))) {
                alert('Please enter a valid Indian mobile number (10 digits starting with 6-9).');
                whatsappPhoneInput.focus();
                return;
            }
            
            this.disabled = true;
            this.innerHTML = '‚è≥ Sending...';
            
            // Send test message via AJAX
            fetch('/test_whatsapp', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    phone_number: phoneNumber
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('‚úÖ Test message sent successfully! Check your WhatsApp.');
                } else {
                    alert('‚ùå Failed to send test message: ' + (data.error || 'Unknown error'));
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('‚ùå Error sending test message. Please try again.');
            })
            .finally(() => {
                this.disabled = false;
                this.innerHTML = 'üß™ Send Test Message';
            });
        });
    }
    
    // Form validation before submit
    const form = document.querySelector('form');
    if (form) {
        form.addEventListener('submit', function(e) {
            if (whatsappCheckbox.checked) {
                const phoneNumber = whatsappPhoneInput.value.trim();
                if (!phoneNumber) {
                    e.preventDefault();
                    alert('Please enter your WhatsApp phone number to enable WhatsApp notifications.');
                    whatsappPhoneInput.focus();
                    return false;
                }
                
                const phoneRegex = /^(\+91|91)?[6-9][0-9]{9}$/;
                if (!phoneRegex.test(phoneNumber.replace(/\s+/g, ''))) {
                    e.preventDefault();
                    alert('Please enter a valid Indian mobile number (10 digits starting with 6-9).');
                    whatsappPhoneInput.focus();
                    return false;
                }
            }
        });
    }
});
</script>
{% endblock %}